<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web/Bin 設定與分配 v24</title>

  <style>
    :root{
      --bg: #f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --success:#16a34a;
      --warn:#f59e0b;
      --error:#ef4444;
      --note-bg:#f2f5ff;
      --note-line:#3b6ff9;
      --radius: 12px;
      --shadow: 0 6px 20px rgba(17,24,39,0.08);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI",
                   "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
    }

    .page{
      max-width: 1100px;
      margin: 20px auto 48px;
      padding: 0 18px;
    }

    .header{
      background: linear-gradient(135deg, #ffffff 0%, #f7f9ff 100%);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title-wrap{
      display:flex; flex-direction:column; gap:4px;
    }
    h1{
      margin:0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      background:#eef2ff;
      color:#3730a3;
      border-radius:999px;
      border:1px solid #e0e7ff;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      margin-bottom:14px;
      position: relative;
    }
    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .step{
      display:flex; align-items:center; gap:10px;
    }
    .step-badge{
      width:30px; height:30px;
      border-radius:8px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:700;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #e0e7ff;
      flex: 0 0 auto;
    }
    .card-title{
      font-size:17px;
      font-weight:700;
    }

    .toggle-btn{
      cursor:pointer;
      font-size:12px;
      color:var(--primary);
      user-select:none;
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:8px;
      border:1px dashed #dbe3ff;
      background:#f8faff;
      white-space:nowrap;
    }
    .toggle-btn:hover{ background:#eef2ff; }

    .note-box{
      background: var(--note-bg);
      border-left: 4px solid var(--note-line);
      padding: 12px 14px;
      border-radius: 8px;
      line-height: 1.6;
      color:#0f172a;
      font-size:13px;
      margin-top: 10px;
      white-space: pre-line;
    }
    .hidden{ display:none; }

    .form-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px 12px;
    }
    @media (max-width: 900px){
      .form-row{ grid-template-columns: 1fr; }
    }
    .form-item{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:14px;
      font-weight:600;
      color:#111827;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    input[type="number"], input[type="text"]{
      width:100%;
      height:36px;
      padding: 6px 10px;
      border-radius: 8px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input[type="file"]{
      width:100%;
      padding:8px;
      border:1px dashed var(--line);
      border-radius: 8px;
      background:#fafafa;
      font-size:14px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 6px;
      vertical-align: middle;
    }
    th{
      background:#f9fafb;
      font-weight:600;
    }

    .actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    button,
    .btn{
      border:0;
      cursor:pointer;
      font-size:15px;
      font-weight:700;
      padding: 10px 16px;
      border-radius: 10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .05s ease, background .15s ease, opacity .15s;
      color:#fff;
    }
    button:active,
    .btn:active{
      transform: translateY(1px);
    }
    .btn-primary{
      background:var(--primary);
      box-shadow: 0 6px 14px rgba(37,99,235,0.25);
    }
    .btn-primary:hover{
      background:var(--primary-2);
    }
    .btn-secondary,
    .btn{
      background:#0ea5a5;
      box-shadow: 0 6px 14px rgba(14,165,165,0.24);
    }
    .btn-secondary:hover,
    .btn:hover{
      opacity:0.95;
    }
    .btn-danger{
      background:#ef4444;
      box-shadow: 0 6px 14px rgba(239,68,68,0.24);
    }
    .btn-danger:hover{
      opacity:0.95;
    }
    button:disabled,
    .btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    #summary-area{
      margin-top:12px;
      font-size:13px;
      background:#f9fafb;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--line);
    }

    .uniform-cell input,
    .uniform-cell select,
    .uniform-cell .kta-row input{
      width: 70px !important;
      max-width: 70px !important;
    }

    .kta-row {
      display: flex;
      gap: 6px;
      white-space: nowrap;
    }

    #bin-table th.bin-uniform,
    #bin-table td.bin-uniform{
      width:33%;
    }

    #bin-table td.bin-uniform input{
      width:100% !important;
      max-width:100% !important;
    }

    #web-table td:last-child,
    #bin-table td:last-child{
      text-align:right;
      width:1%;
      white-space:nowrap;
    }

    #summary-area table th,
    #summary-area table td {
      text-align: left !important;
    }

    #web-table tbody tr,
    #bin-table tbody tr {
      cursor: move;
      transition: background-color 0.15s ease, opacity 0.15s ease;
    }

    #web-table tbody tr:hover,
    #bin-table tbody tr:hover {
      background-color: #eef2ff;
    }

    .dragging-row {
      opacity: 0.7;
      background-color: #dbeafe !important;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
<div class="page">

  <div class="header">
    <div class="title-wrap">
      <h1>Web/Bin Settings & Allocation</h1>
      <div class="subtitle">v24（拖曳排序｜Save｜Summary 修正）</div>
    </div>
    <div class="chip">RNG Tools</div>
  </div>

  <!-- Step 1：Web 設定 -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">1</div>
        <div class="card-title">Web Settings</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-web', this)">ⓘ Open</div>
    </div>

    <div id="note-web" class="note-box hidden">
・Each Web row: Key + TG + ARA = 100
・Total Web Red% must equal 100
・Total Web + Bin Other% must equal 100
・TG format: Week ID Num B-S or ID Week Num B-S
・Used to allocate red numbers and others

・每一列 Web 的「Key + TG + ARA = 100」
・全部 Web 的 Red% 總和 = 100
・全部 Web + Bin 的 Other% 總和 = 100
・TG 格式可選：星期 ID 號碼 大-小 / ID 星期 號碼 大-小
・用來分配紅字與其他號碼
    </div>

    <table id="web-table">
      <thead>
        <tr>
          <th>Co. Name</th>
          <th>ARA ID</th>
          <th>TG ID</th>
          <th>TG Fmt</th>
          <th>TG Cnt</th>
          <th>Key / TG / ARA (%)</th>
          <th>Red (%)</th>
          <th>Other (%)</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions" style="justify-content:flex-start; gap:8px;">
      <button class="btn-primary" id="add-web-row-btn">+ Add Web </button>
      <button class="btn" id="save-web-config-btn">Save</button>
    </div>
  </section>

  <!-- Step 2：Bin 設定 -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">2</div>
        <div class="card-title">Bin Settings</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-bin', this)">ⓘ Open</div>
    </div>

    <div id="note-bin" class="note-box hidden">
・Total Web + Bin Other% must equal 100
・Bin contains only ARA (no Key/TG)
・Other% defines how“other numbers” are assigned to Bin

・全部 Web + Bin 的 Other% 總和 = 100
・Bin 只有 ARA（沒有 Key / TG）
・Other% 代表「其他號碼」分到 Bin 的比例
    </div>

    <table id="bin-table">
      <thead>
        <tr>
          <th class="bin-uniform">Co. Name</th>
          <th class="bin-uniform">ARA ID</th>
          <th class="bin-uniform">Other (%)</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions" style="justify-content:flex-start; gap:8px;">
      <button class="btn-primary" id="add-bin-row-btn">+ Add Bin </button>
      <button class="btn" id="save-bin-config-btn">Save</button>
    </div>
  </section>

  <!-- Step 3：上傳檔案 -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">3</div>
        <div class="card-title">Upload Red & Other Numbers / 上傳紅字& 其他字檔案</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-upload', this)">ⓘ Open</div>
    </div>

    <div id="note-upload" class="note-box hidden">
Red TXT Format
0001 2 4
1234 2 4

Other TXT Format (incl. r)
5678 1 2
8888r 1 0
(r goes only to Web-Key or Web-TG based on rules)
(r 會依規則只進 Web-Key 或 Web-TG)
⚠️ Week is required; validated before Allocate/Download
⚠️ 星期必填，按「分配」與「下載」前會檢查。
    </div>

    <div class="form-row" style="margin-top:6px;">
      <div class="form-item" style="grid-column:1/-1;">
        <label>Upload Red File (.txt)</label>
        <input type="file" id="red-file" accept=".txt" />
      </div>
    </div>

    <div class="form-row" style="margin-top:6px; align-items:flex-end;">
      <div class="form-item" style="grid-column:1/3;">
        <label>Upload Other Numbers (.txt)</label>
        <input type="file" id="other-file" accept=".txt" />
        <div class="hint">Includes normal and R numbers / 包含一般號碼與 r 號碼</div>
      </div>
      <div class="form-item">
        <label>Week (Required / 必填)</label>
        <input type="number" id="other-week" step="1" placeholder="For example：3" />
        <div class="hint">Required before “Allocate” / 按「分配」前一定要填寫</div>
      </div>
    </div>
  </section>

  <!-- Step 4：分配 & 下載 -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">4</div>
        <div class="card-title">Allocate & Download / 分配&下載</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-download', this)">ⓘ Open</div>
    </div>

    <div id="note-download" class="note-box hidden">
Summary:
Lines: Actual number of output lines, including TG auto-grouping.
Records: Original record count (r numbers not expanded).
Unique: Total unique numbers after expanding all r numbers.
Big: Total Big count after r expansion.
Small: Total Small count after r expansion.
Amount: Total amount = Big × 1.6 + Small × 0.7.
R Count: Number of original records that contain an r.
R%: This file’s R Count as a percentage of overall R Count.
Total: Sum across all files; Unique is based on all expanded numbers.

Lines：本檔最終輸出行數（含 TG 自動分組後的結果）。
Records：原始筆數（r 不拆開）。
Unique：展開 r 後去重的實際號碼數量。
Big：展開 r 後累計的大總數。
Small：展開 r 後累計的小總數。
Amount：金額＝Big×1.6 + Small×0.7。
R Count：本檔原始資料中含 r 的筆數。
R%：本檔 R Count 占所有檔案 R Count 的比例。
Total：各欄位加總；Unique 為全部展開後號碼的去重總數。
    </div>

    <div class="actions" style="justify-content:flex-start; margin-top:6px;">
      <button class="btn-primary" id="allocate-btn">Allocate</button>
      <button class="btn-secondary" id="download-all-rar-btn" disabled>Download</button>
    </div>

    <div id="summary-area" class="hint"></div>
  </section>

<script>
const PRICE_BIG = 1.6;
const PRICE_SMALL = 0.7;

/* R排列數用不到了，但先保留 */
function getRMultiplierFromNumber(numStr) {
  if (!numStr) return 1;
  const s = String(numStr).padStart(4, "0").slice(-4);
  const freq = {};
  for (const ch of s) {
    freq[ch] = (freq[ch] || 0) + 1;
  }
  const counts = Object.values(freq);

  function fact(n) {
    if (n <= 1) return 1;
    if (n === 2) return 2;
    if (n === 3) return 6;
    if (n === 4) return 24;
    return 1;
  }
  let denom = 1;
  counts.forEach(c => denom *= fact(c));
  const total = fact(4) / denom;
  return total || 1;
}

// 展開 R → 所有不重複排列
function permR(code) {
  const s = String(code).padStart(4, "0").slice(-4);
  const chars = s.split("").sort();
  const used = new Array(chars.length).fill(false);
  const res = new Set();

  (function dfs(path) {
    if (path.length === chars.length) {
      res.add(path.join(""));
      return;
    }
    for (let i = 0; i < chars.length; i++) {
      if (used[i]) continue;
      if (i > 0 && chars[i] === chars[i - 1] && !used[i - 1]) continue;
      used[i] = true;
      path.push(chars[i]);
      dfs(path);
      path.pop();
      used[i] = false;
    }
  })([]);

  return Array.from(res);
}

/* 說明展開/收合 */
function toggleNote(id, btnEl) {
  const note = document.getElementById(id);
  if (!note) return;
  if (note.classList.contains('hidden')) {
    note.classList.remove('hidden');
    btnEl.textContent = 'ⓘ Close';
  } else {
    note.classList.add('hidden');
    btnEl.textContent = 'ⓘ Open';
  }
}

/* 全域變數 & DOM */
const webTableBody = document.querySelector('#web-table tbody');
const binTableBody = document.querySelector('#bin-table tbody');

makeTableDraggable(webTableBody);
makeTableDraggable(binTableBody);

const redFileInput = document.getElementById('red-file');
const otherFileInput = document.getElementById('other-file');
const otherWeekInput = document.getElementById('other-week');

const allocateBtn = document.getElementById('allocate-btn');
const downloadAllRarBtn = document.getElementById('download-all-rar-btn');
const summaryArea = document.getElementById('summary-area');

let redFileContent = '';
let otherFileContent = '';
let lastOutputs = null;

/* 星期必填 */
function validateWeekRequired() {
  const week = otherWeekInput.value.trim();
  if (week === "") {
    alert("Fill in“Week”first / 請先填寫『星期』");
    return false;
  }
  return true;
}

/* 其他字 TXT 必須上傳 */
function validateOtherFileRequired() {
  if (!otherFileContent || otherFileContent.trim() === "") {
    alert("Upload“Other TXT”first / 請先上傳『其他字 TXT』");
    return false;
  }
  return true;
}

/* 工具函式 */
function rand() { return Math.random(); }

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function bigSmallDash(b, s) {
  b = b || 0;
  s = s || 0;
  if (b > 0 && s > 0) return `${b}-${s}`;
  if (b > 0 && s == 0) return `${b}-`;
  if (b == 0 && s > 0) return `-${s}`;
  return `-`;
}

function formatKeyLine(r) {
  return `${r.num} ${bigSmallDash(r.big, r.small)}`;
}

function padLeft(str, width) {
  str = String(str);
  if (str.length >= width) return str;
  return " ".repeat(width - str.length) + str;
}

function formatAraLine(r, araIdOverride) {
  const dateStr = r.date || "";
  let araId = araIdOverride || r.araId || "";
  const b = r.big || 0;
  const s = r.small || 0;

  const bigField   = b > 0 ? padLeft(b, 4) : "    ";
  const smallField = s > 0 ? padLeft(s, 3) : "   ";

  if (araId.length < 4) {
    araId = araId + " ".repeat(4 - araId.length);
  }
  return `${dateStr}+${r.num}+${bigField}+${smallField}+${araId}*1|N`;
}

/* TG Cnt 解析 & 分組 */
function parseTgCntRange(tgCntRaw) {
  const s = (tgCntRaw || "").trim();
  if (!s || s === "0") return null;

  const mRange = s.match(/^(\d+)\s*-\s*(\d+)$/);
  if (mRange) {
    const minG = parseInt(mRange[1], 10);
    const maxG = parseInt(mRange[2], 10);
    if (minG >= 1 && maxG >= minG) return [minG, maxG];
    throw new Error("TG Cnt 範圍不合法，需 >=1 且 max>=min");
  }
  const mNum = s.match(/^\d+$/);
  if (mNum) {
    const v = parseInt(s, 10);
    if (v >= 1) return [v, v];
  }
  throw new Error("TG Cnt 格式必須是單一數字(如 8) 或範圍(如 7-10)");
}

function parseTgLine(line) {
  const parts = line.trim().split(/\s+/);
  if (parts.length >= 4) {
    return {
      prefix: parts[0] + " " + parts[1],
      code: parts[2],
      marker: parts[3]
    };
  }
  const m = line.trim().match(/^(\S+\s+\S+)\s+(\S+)\s+(\S+)\s*$/);
  if (m) return { prefix: m[1], code: m[2], marker: m[3] };
  return null;
}

function combineTgSlice(lines, startIdx, count, badLines) {
  const slice = lines.slice(startIdx, startIdx + count);
  const parsed = [];
  for (const raw of slice) {
    const p = parseTgLine(raw);
    if (p) parsed.push(p);
    else badLines.push(raw);
  }
  if (parsed.length === 0) return null;

  const prefix = parsed[0].prefix;
  const groups = [];
  const seen = new Map();

  for (const item of parsed) {
    const { code, marker } = item;
    if (!seen.has(marker)) {
      seen.set(marker, groups.length);
      groups.push({ marker, codes: [] });
    }
    groups[seen.get(marker)].codes.push(code);
  }

  const out = [prefix];
  for (const g of groups) {
    out.push(g.codes.join(" "));
    out.push(g.marker);
  }
  return out.join(" ").trim();
}

function groupTgLines(lines, tgCntRaw) {
  let range;
  try {
    range = parseTgCntRange(tgCntRaw);
  } catch (e) {
    alert(e.message || e);
    return lines;
  }
  if (!range) return lines;

  const [minG, maxG] = range;
  let i = 0;
  const results = [];
  const badLines = [];

  while (i < lines.length) {
    const remaining = lines.length - i;
    let groupSize;

    if (remaining < minG) {
      groupSize = remaining;
    } else {
      groupSize = Math.min(
        remaining,
        Math.floor(rand() * (maxG - minG + 1)) + minG
      );
    }
    const combined = combineTgSlice(lines, i, groupSize, badLines);
    if (combined) results.push(combined);
    i += groupSize;
  }

  if (badLines.length) {
    console.warn("TG grouping bad lines:", badLines);
  }
  return results;
}

/* 建立 Web / Bin 列 */
function createWebRow() {
  const tr = document.createElement("tr");
  tr.draggable = true;
  tr.innerHTML = `
    <td><input type="text" class="web-co-name"></td>
    <td><input type="text" class="web-ara-id"></td>
    <td><input type="text" class="web-tg-id"></td>
    <td>
      <select class="web-tg-format">
        <option value="dateFirst">Week ID</option>
        <option value="tgFirst">ID Week</option>
      </select>
    </td>
    <td class="uniform-cell">
      <input type="text" class="web-tg-cnt">
    </td>
    <td class="uniform-cell">
      <div class="kta-row">
        <input type="number" class="kta kta-key" placeholder="Key" step="1" min="0" max="100">
        <input type="number" class="kta kta-tg"  placeholder="TG"  step="1" min="0" max="100">
        <input type="number" class="kta kta-ara" placeholder="ARA" step="1" min="0" max="100">
      </div>
    </td>
    <td class="uniform-cell">
      <input type="number" class="web-red" step="1" min="0" max="100">
    </td>
    <td class="uniform-cell">
      <input type="number" class="web-other" step="1" min="0" max="100">
    </td>
    <td><button class="btn btn-danger btn-delete-row">Del</button></td>
  `;
  tr.querySelector(".btn-delete-row").onclick = () => tr.remove();
  return tr;
}

function createBinRow() {
  const tr = document.createElement("tr");
  tr.draggable = true;
  tr.innerHTML = `
    <td class="bin-uniform"><input type="text" class="bin-co-name"></td>
    <td class="bin-uniform"><input type="text" class="bin-ara-id"></td>
    <td class="bin-uniform"><input type="number" class="bin-other-percent" step="1" min="0" max="100"></td>
    <td class="delete-cell"><button class="btn btn-danger btn-delete-row">Del</button></td>
  `;
  tr.querySelector(".btn-delete-row").onclick = () => tr.remove();
  return tr;
}

/* 讓表格支援拖曳排序 */
function makeTableDraggable(tbody) {
  let draggingRow = null;

  tbody.addEventListener("dragstart", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;
    draggingRow = tr;
    tr.classList.add("dragging-row");
    if (e.dataTransfer) {
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", "");
    }
  });

  tbody.addEventListener("dragover", (e) => {
    if (!draggingRow) return;
    e.preventDefault();
    const tr = e.target.closest("tr");
    if (!tr || tr === draggingRow) return;

    const rect = tr.getBoundingClientRect();
    const offset = e.clientY - rect.top;
    const middle = rect.height / 2;

    if (offset < middle) {
      tbody.insertBefore(draggingRow, tr);
    } else {
      tbody.insertBefore(draggingRow, tr.nextSibling);
    }
  });

  tbody.addEventListener("dragend", () => {
    if (draggingRow) {
      draggingRow.classList.remove("dragging-row");
      draggingRow = null;
    }
  });

  tbody.addEventListener("drop", (e) => {
    e.preventDefault();
  });
}

/* localStorage：只記 Web / Bin 設定 */
const STORAGE_KEY = "wbv21_last_config";

function saveLastConfig() {
  const cfg = getCurrentConfig();
  const dataToStore = {
    web: cfg.web,
    bin: cfg.bin
  };
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToStore));
  } catch (e) {
    console.warn("WBv21：儲存設定失敗", e);
  }
}

function restoreLastConfig() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  let data;
  try {
    data = JSON.parse(raw);
  } catch (e) {
    console.warn("WBv21：解析儲存設定失敗", e);
    return false;
  }
  if (!data.web && !data.bin) return false;

  webTableBody.innerHTML = "";
  binTableBody.innerHTML = "";

  if (Array.isArray(data.web)) {
    data.web.forEach(w => {
      const tr = createWebRow();
      tr.querySelector(".web-co-name").value   = w.coName || "";
      tr.querySelector(".web-ara-id").value    = w.araId  || "";
      tr.querySelector(".web-tg-id").value     = w.tgId   || "";
      tr.querySelector(".web-tg-format").value = w.tgFormat || "dateFirst";
      tr.querySelector(".web-tg-cnt").value    = w.tgCnt || "";
      tr.querySelector(".kta-key").value       = w.keyVal       || "";
      tr.querySelector(".kta-tg").value        = w.tgVal        || "";
      tr.querySelector(".kta-ara").value       = w.araVal       || "";
      tr.querySelector(".web-red").value       = w.redPercent   || "";
      tr.querySelector(".web-other").value     = w.otherPercent || "";
      webTableBody.appendChild(tr);
    });
  }

  if (Array.isArray(data.bin)) {
    data.bin.forEach(b => {
      const tr = createBinRow();
      tr.querySelector(".bin-co-name").value        = b.coName || "";
      tr.querySelector(".bin-ara-id").value         = b.araId  || "";
      tr.querySelector(".bin-other-percent").value  = b.otherPercent || "";
      binTableBody.appendChild(tr);
    });
  }
  return true;
}

/* 上傳紅字 / 其他字 */
redFileInput.addEventListener("change", e => {
  const f = e.target.files[0];
  redFileContent = "";
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    redFileContent = reader.result || "";
  };
  reader.readAsText(f, "utf-8");
});

otherFileInput.addEventListener("change", e => {
  const f = e.target.files[0];
  otherFileContent = "";
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    otherFileContent = reader.result || "";
  };
  reader.readAsText(f, "utf-8");
});

/* 解析紅字 */
function parseRedNumbers(cfg) {
  const res = [];
  const txt = cfg.red.content || "";

  const overrideBig =
    cfg.red.big !== undefined && cfg.red.big !== "" ? Number(cfg.red.big) : null;
  const overrideSmall =
    cfg.red.small !== undefined && cfg.red.small !== "" ? Number(cfg.red.small) : null;

  txt.split(/\r?\n/).forEach(line => {
    const s = line.trim();
    if (!s) return;

    const parts = s.split(/\s+/);
    const numOnly = parts[0];

    if (!/^\d{4}$/.test(numOnly)) return;

    let originalBig = 0;
    let originalSmall = 0;

    if (parts.length >= 3) {
      const b = Number(parts[1]);
      const sm = Number(parts[2]);
      if (!Number.isNaN(b)) originalBig = b;
      if (!Number.isNaN(sm)) originalSmall = sm;
    }

    res.push({
      num: numOnly,
      baseNum: numOnly,
      displayNum: numOnly,
      big: overrideBig !== null ? overrideBig : originalBig,
      small: overrideSmall !== null ? overrideSmall : originalSmall,
      isRed: true,
      isRoll: false
    });
  });
  return res;
}

/* 解析其他字（含 r） */
function parseOtherNumbers(cfg) {
  const res = [];
  const txt = cfg.other.content || "";

  txt.split(/\r?\n/).forEach(line => {
    const s = line.trim();
    if (!s) return;

    const parts = s.split(/\s+/);
    if (parts.length < 3) return;

    let head = parts[0];
    let bigStr = parts[1];
    let smallStr = parts[2];

    let isRoll = false;
    let baseNum = "";

    if (/^\d{4}r$/i.test(head)) {
      isRoll = true;
      baseNum = head.slice(0, 4);
    } else if (/^\d{4}$/.test(head)) {
      baseNum = head;
    } else {
      return;
    }

    const big = Number(bigStr);
    const small = Number(smallStr);
    if (Number.isNaN(big) || Number.isNaN(small)) return;

    res.push({
      num: head,
      displayNum: head,
      baseNum,
      big,
      small,
      isRed: false,
      isRoll
    });
  });

  return res;
}

/* 取得 Web / Bin 設定 */
function getCurrentConfig() {
  const web = [...webTableBody.querySelectorAll("tr")].map(tr => ({
    coName: tr.querySelector(".web-co-name").value.trim(),
    araId:  tr.querySelector(".web-ara-id").value.trim(),
    tgId:   tr.querySelector(".web-tg-id").value.trim(),
    tgFormat: tr.querySelector(".web-tg-format").value,
    tgCnt: tr.querySelector(".web-tg-cnt").value.trim(),
    keyVal:   tr.querySelector(".kta-key").value,
    tgVal:    tr.querySelector(".kta-tg").value,
    araVal:   tr.querySelector(".kta-ara").value,
    redPercent:   tr.querySelector(".web-red").value,
    otherPercent: tr.querySelector(".web-other").value
  }));

  const bin = [...binTableBody.querySelectorAll("tr")].map(tr => ({
    coName: tr.querySelector(".bin-co-name").value.trim(),
    araId:  tr.querySelector(".bin-ara-id").value.trim(),
    otherPercent: tr.querySelector(".bin-other-percent").value
  }));

  return {
    web,
    bin,
    red: {
      content: redFileContent
    },
    other: {
      content: otherFileContent,
      week: otherWeekInput.value
    }
  };
}

/* 檢查百分比（不再 throw，改回傳 false） */
function validatePercents(cfg) {
  const epsilon = 0.001;
  let sumRed = 0;
  let sumOther = 0;

  for (let idx = 0; idx < cfg.web.length; idx++) {
    const w = cfg.web[idx];
    const r = w.redPercent ? Number(w.redPercent) : 0;
    const o = w.otherPercent ? Number(w.otherPercent) : 0;
    sumRed += r;
    sumOther += o;

    const key = w.keyVal ? Number(w.keyVal) : 0;
    const tg  = w.tgVal  ? Number(w.tgVal)  : 0;
    const ara = w.araVal ? Number(w.araVal) : 0;
    const sumKTA = key + tg + ara;

    if (key || tg || ara) {
      if (Math.abs(sumKTA - 100) > epsilon) {
        alert(`第 ${idx + 1} 列 Web 的 Key+TG+ARA 必須 = 100，目前為：${sumKTA}`);
        return false;
      }
    }
  }

  cfg.bin.forEach(b => {
    const o = b.otherPercent ? Number(b.otherPercent) : 0;
    sumOther += o;
  });

  if (Math.abs(sumRed - 100) > epsilon) {
    alert(`Total Web Red% must be 100, current: ${sumRed}`);
    return false;
  }
  if (Math.abs(sumOther - 100) > epsilon) {
    alert(`Total Web+Bin Other % must be 100, current:  ${sumOther}`);
    return false;
  }
  return true;
}

/* finalize：依 outputs 產生一次 fileContent（固定亂數 & TG 分組） */
function generateFileContents(outputs) {
  Object.keys(outputs).forEach(k => {
    const o = outputs[k];
    const list = o.list || [];
    if (!list.length) {
      o.fileContent = "";
      return;
    }

    let lines = [];

    if (o.type === "web-key") {
      const cloned = list.slice();
      shuffle(cloned);
      lines = cloned.map(r => formatKeyLine(r));
    }

    if (o.type === "web-tg") {
      const cloned = list.slice();
      shuffle(cloned);

      let rawLines = cloned.map(r => {
        const date = r.date || "";
        const bs = bigSmallDash(r.big, r.small);
        if (o.tgFormat === "tgFirst") {
          return `${o.tgId} ${date} ${r.num} ${bs}`.trim();
        }
        return `${date} ${o.tgId} ${r.num} ${bs}`.trim();
      });

      if (o.tgCnt && o.tgCnt.trim() && o.tgCnt.trim() !== "0") {
        rawLines = groupTgLines(rawLines, o.tgCnt);
      }
      lines = rawLines;
    }

    if (o.type === "web-ara" || o.type === "bin-ara") {
      const cloned = list.slice();
      shuffle(cloned);
      lines = cloned.map(r => formatAraLine(r, o.araId));
    }

    o.fileContent = (lines || []).join("\n");
  });
}

/* 分配核心 */
function allocateOnce() {
  const cfg = getCurrentConfig();
  if (!validatePercents(cfg)) return null;

  const redList   = parseRedNumbers(cfg);
  const otherList = parseOtherNumbers(cfg);
  const pool = [...redList, ...otherList];

  const dateVal = cfg.other.week || "";

  const webList = cfg.web.map((w, idx) => ({
    index: idx,
    coName: w.coName || `Web${idx+1}`,
    araId:  w.araId || "",
    tgId:   w.tgId || "",
    tgFormat: w.tgFormat,
    tgCnt: w.tgCnt,
    keyPct:  w.keyVal   ? Number(w.keyVal)   : 0,
    tgPct:   w.tgVal    ? Number(w.tgVal)    : 0,
    araPct:  w.araVal   ? Number(w.araVal)   : 0,
    redPct:  w.redPercent   ? Number(w.redPercent)   : 0,
    otherPct:w.otherPercent ? Number(w.otherPercent) : 0
  }));

  const binList = cfg.bin.map((b, idx) => ({
    index: idx,
    coName: b.coName || `Bin${idx+1}`,
    araId:  b.araId || "",
    otherPct: b.otherPercent ? Number(b.otherPercent) : 0
  }));

  const webRedWeights   = webList.map(w => Math.max(0, w.redPct));
  const webOtherWeights = webList.map(w => Math.max(0, w.otherPct));
  const binOtherWeights = binList.map(b => Math.max(0, b.otherPct));

  const outputs = {};

  function ensureWebKey(co, tg) {
    const key = `web-key::${co}::${tg}`;
    if (!outputs[key]) outputs[key] = { type: "web-key", coName: co, tgId: tg, list: [] };
    return outputs[key];
  }
  function ensureWebTg(co, tg, fmt, cnt) {
    const key = `web-tg::${co}::${tg}`;
    if (!outputs[key]) {
      outputs[key] = {
        type: "web-tg",
        coName: co,
        tgId: tg,
        tgFormat: fmt,
        tgCnt: cnt || "",
        list: []
      };
    }
    return outputs[key];
  }
  function ensureWebAra(co, ara) {
    const key = `web-ara::${co}::${ara}`;
    if (!outputs[key]) outputs[key] = { type: "web-ara", coName: co, araId: ara, list: [] };
    return outputs[key];
  }
  function ensureBinAra(co, ara) {
    const key = `bin-ara::${co}::${ara}`;
    if (!outputs[key]) outputs[key] = { type: "bin-ara", coName: co, araId: ara, list: [] };
    return outputs[key];
  }

  function pickIndex(weights) {
    const total = weights.reduce((s, x) => s + x, 0);
    if (total <= 0) return -1;
    let r = rand() * total;
    for (let i = 0; i < weights.length; i++) {
      r -= weights[i];
      if (r <= 0) return i;
    }
    return weights.length - 1;
  }

  /* 分配 */
  for (const obj of pool) {
    const isRed  = obj.isRed;
    const isRoll = !!obj.isRoll;
    const num    = obj.displayNum;
    const big    = obj.big;
    const small  = obj.small;

    const baseNum = obj.baseNum || obj.num || obj.displayNum;

    /* 紅字 */
    if (isRed) {
      const idx = pickIndex(webRedWeights);
      const w = webList[idx];
      const t = w.keyPct + w.tgPct + w.araPct;

      if (t <= 0) {
        ensureWebAra(w.coName, w.araId).list.push({ num, baseNum, big, small, date: dateVal, isRoll });
        continue;
      }

      let r = rand() * t;
      if (r <= w.keyPct) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, baseNum, big, small, isRoll });
      } else if (r <= w.keyPct + w.tgPct) {
        ensureWebTg(w.coName, w.tgId, w.tgFormat, w.tgCnt)
          .list.push({ num, baseNum, big, small, date: dateVal, isRoll });
      } else {
        ensureWebAra(w.coName, w.araId).list.push({ num, baseNum, big, small, date: dateVal, isRoll });
      }
      continue;
    }

    /* r 號碼 */
    if (isRoll) {
      const candidateIdx = [];
      const candidateWeights = [];

      webList.forEach((w, i) => {
        const canTakeR = (webOtherWeights[i] > 0) && ((w.keyPct + w.tgPct) > 0);
        if (canTakeR) {
          candidateIdx.push(i);
          candidateWeights.push(webOtherWeights[i]);
        }
      });

      if (!candidateIdx.length) {
        alert("有 r 號碼，但沒有任何可接收 r 的 Web（需 Other% > 0 且 Key+TG > 0）");
        return null;
      }

      const pickPos = pickIndex(candidateWeights);
      const wIndex = candidateIdx[pickPos];
      const w = webList[wIndex];

      const t = w.keyPct + w.tgPct;
      let rVal = rand() * t;

      if (rVal <= w.keyPct) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, baseNum, big, small, isRoll });
      } else {
        ensureWebTg(w.coName, w.tgId, w.tgFormat, w.tgCnt)
          .list.push({ num, baseNum, big, small, date: dateVal, isRoll });
      }
      continue;
    }

    /* 其他字 */
    const totalOther =
      webOtherWeights.reduce((s, x) => s + x, 0) +
      binOtherWeights.reduce((s, x) => s + x, 0);

    if (totalOther <= 0) continue;

    let r = rand() * totalOther;
    let acc = 0;
    let target = null;

    for (let i = 0; i < webList.length; i++) {
      acc += webOtherWeights[i];
      if (r <= acc) { target = { kind: "web", i }; break; }
    }
    if (!target) {
      for (let i = 0; i < binList.length; i++) {
        acc += binOtherWeights[i];
        if (r <= acc) { target = { kind: "bin", i }; break; }
      }
    }
    if (!target) continue;

    if (target.kind === "bin") {
      const bObj = binList[target.i];
      ensureBinAra(bObj.coName, bObj.araId)
        .list.push({ num, baseNum, big, small, date: dateVal, isRoll });
    } else {
      const w = webList[target.i];
      const t2 = w.keyPct + w.tgPct + w.araPct;
      if (t2 <= 0) {
        ensureWebAra(w.coName, w.araId).list.push({ num, baseNum, big, small, date: dateVal, isRoll });
        continue;
      }

      let r2 = rand() * t2;
      let acc2 = w.keyPct;
      if (r2 <= acc2) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, baseNum, big, small, isRoll });
        continue;
      }
      acc2 += w.tgPct;
      if (r2 <= acc2) {
        ensureWebTg(w.coName, w.tgId, w.tgFormat, w.tgCnt)
          .list.push({ num, baseNum, big, small, date: dateVal, isRoll });
        continue;
      }
      ensureWebAra(w.coName, w.araId).list.push({ num, baseNum, big, small, date: dateVal, isRoll });
    }
  }

  // ✅ 在這裡就先把每個檔案的 fileContent 產生好（亂數 & TG 分組只做一次）
  generateFileContents(outputs);
  return outputs;
}

/* Summary：照你定義的 Unique / Big / Small / Amount */
function buildSummary(outputs) {
  const rows = [];

  let totalLines = 0;
  let totalRecords = 0;
  let totalBig = 0;
  let totalSmall = 0;
  let totalAmount = 0;
  let totalRCount = 0;

  const totalUniqueSet = new Set();

  Object.keys(outputs).sort().forEach(key => {
    const o = outputs[key];
    const arr = o.list || [];

    const records = arr.length;

    let lines = 0;
    const fileText = buildFileContent(o) || "";
    if (fileText.trim() !== "") {
      lines = fileText
        .replace(/\r/g, "")
        .split("\n")
        .filter(l => l.trim() !== "").length;
    }

    const expandedRecs = [];
    let rCount = 0;

    arr.forEach(x => {
      const numRaw = x.num || x.displayNum || x.baseNum || "";

      let baseDigits = x.baseNum || "";
      if (!baseDigits) {
        baseDigits = (numRaw.match(/\d{4}/) || ["0000"])[0];
      }
      const base = String(baseDigits).padStart(4, "0").slice(-4);

      const big = x.big || 0;
      const small = x.small || 0;

      if (x.isRoll) {
        rCount++;
        const perms = permR(base);
        perms.forEach(n => {
          expandedRecs.push({
            num: n,
            big,
            small,
            isRoll: true
          });
        });
      } else {
        expandedRecs.push({
          num: base,
          big,
          small,
          isRoll: false
        });
      }
    });

    const fileUniqueSet = new Set();
    let bigTotal = 0;
    let smallTotal = 0;

    expandedRecs.forEach(r => {
      if (r.num) {
        fileUniqueSet.add(r.num);
        totalUniqueSet.add(r.num);
      }
      bigTotal += r.big;
      smallTotal += r.small;
    });

    const unique = fileUniqueSet.size;
    const amount = bigTotal * PRICE_BIG + smallTotal * PRICE_SMALL;

    let fileName = "";
    if (o.type === "web-key") fileName = `${o.coName}_${o.tgId}_KEY`;
    if (o.type === "web-tg")  fileName = `${o.coName}_${o.tgId}_TG`;
    if (o.type === "web-ara") fileName = `${o.coName}_${o.araId}_ARA(Web)`;
    if (o.type === "bin-ara") fileName = `${o.coName}_${o.araId}_ARA(Bin)`;

    rows.push({
      fileName,
      lines,
      records,
      unique,
      bigTotal,
      smallTotal,
      amount,
      rCount
    });

    totalLines   += lines;
    totalRecords += records;
    totalBig     += bigTotal;
    totalSmall   += smallTotal;
    totalAmount  += amount;
    totalRCount  += rCount;
  });

  const bodyHtml = rows.map(r => {
    const rPct = totalRCount > 0
      ? (r.rCount * 100 / totalRCount).toFixed(2) + "%"
      : "0.00%";

    return `
      <tr>
        <td>${r.fileName}</td>
        <td>${r.lines}</td>
        <td>${r.records}</td>
        <td>${r.unique}</td>
        <td>${r.bigTotal}</td>
        <td>${r.smallTotal}</td>
        <td>${r.amount.toFixed(1)}</td>
        <td>${r.rCount}</td>
        <td>${rPct}</td>
      </tr>
    `;
  }).join("");

  const totalRPct = totalRCount > 0 ? "100.00%" : "0.00%";

  const totalRow = `
    <tr style="font-weight:bold; background:#eef2ff;">
      <td>Total</td>
      <td>${totalLines}</td>
      <td>${totalRecords}</td>
      <td>${totalUniqueSet.size}</td>
      <td>${totalBig}</td>
      <td>${totalSmall}</td>
      <td>${totalAmount.toFixed(1)}</td>
      <td>${totalRCount}</td>
      <td>${totalRPct}</td>
    </tr>
  `;

  return `
    <table>
      <thead>
        <tr>
          <th>File Name</th>
          <th>Lines行數</th>
          <th>Records筆數</th>
          <th>Unique去重</th>
          <th>Big</th>
          <th>Small</th>
          <th>Amount</th>
          <th>R Count</th>
          <th>R%</th>
        </tr>
      </thead>
      <tbody>
        ${bodyHtml}
        ${totalRow}
      </tbody>
    </table>
  `;
}

/* buildFileContent：現在只回傳 allocate 時已生成好的 fileContent */
function buildFileContent(o) {
  return (o && typeof o.fileContent === "string") ? o.fileContent : "";
}

/* 下載單一 TXT */
function downloadTextFile(filename, content) {
  if (content == null) content = "";
  const crlfContent = content.replace(/\r?\n/g, "\r\n");
  const blob = new Blob([crlfContent], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* Download_All 內容 */
function buildAllInOne(outputs, redFileContent) {
  function normLines(text) {
    return text.replace(/\r/g, "").split("\n").filter(l => l.trim() !== "");
  }

  const sections = [];
  const keys = Object.keys(outputs || {});

  function pushSection(type, name, lines) {
    const lineCount = lines.length;
    let block =
      `type:${type} ${name}\n` +
      `line:${lineCount}\n` +
      lines.join("\n") + "\n" +
      `endtype:${type} ${name}`;
    sections.push(block);
  }

  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-ara" || o.type === "bin-ara")
    .sort((a,b)=> `${a.coName}_${a.araId}`.localeCompare(`${b.coName}_${b.araId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.araId}_ARA`;
      pushSection("ara", name, lines);
    });

  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-tg")
    .sort((a,b)=> `${a.coName}_${a.tgId}`.localeCompare(`${b.coName}_${b.tgId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.tgId}_TG`;
      pushSection("tg", name, lines);
    });

  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-key")
    .sort((a,b)=> `${a.coName}_${a.tgId}`.localeCompare(`${b.coName}_${b.tgId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.tgId}_KEY`;
      pushSection("keyin", name, lines);
    });

  if (redFileContent && redFileContent.trim()) {
    let lines = redFileContent.replace(/\r/g, "").split("\n");
    while (lines.length && lines[lines.length - 1].trim() === "") {
      lines.pop();
    }
    pushSection("redfont", "", lines);
  }
  return sections.join("\n");
}

/* 個別下載區 */
function downloadWebAra(outputs) {
  const keys = Object.keys(outputs);
  let count = 0;

  keys.forEach(k => {
    const o = outputs[k];
    if (o.type === "web-ara") {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;

      const fileName = `${o.coName}_${o.araId}_ARA.ara`;
      downloadTextFile(fileName, fileContent);
      count++;
    }
  });

  alert(`已下載 Web_ARA 檔案 ${count} 個`);
}

async function downloadWebKeyTg(outputs) {
  const zip = new JSZip();
  let count = 0;
  const keys = Object.keys(outputs);

  for (const k of keys) {
    const o = outputs[k];
    if (o.type === "web-key" || o.type === "web-tg") {
      const fileContent = buildFileContent(o);
      if (!fileContent) continue;

      let fileName = "";
      if (o.type === "web-key") fileName = `${o.coName}_${o.tgId}_KEY.txt`;
      if (o.type === "web-tg")  fileName = `${o.coName}_${o.tgId}_TG.txt`;

      const crlfContent = fileContent.replace(/\r?\n/g, "\r\n");
      zip.file(fileName, crlfContent);
      count++;
    }
  }

  if (count === 0) {
    alert("沒有可下載的 Web_KEY/TG 檔案");
    return;
  }

  const blob = await zip.generateAsync({ type: "blob" });
  saveAs(blob, "Web_KEY_TG.rar");
}

function downloadBin(outputs) {
  const keys = Object.keys(outputs);
  let count = 0;

  keys.forEach(k => {
    const o = outputs[k];
    if (o.type === "bin-ara") {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;

      const fileName = `${o.coName}_${o.araId}_ARA.ara`;
      downloadTextFile(fileName, fileContent);
      count++;
    }
  });

  alert(`已下載 Bin 檔案 ${count} 個`);
}

/* All.rar 下載（WebARA / WebKEYTG / Bin / download_all） */
async function downloadAllRar(outputs, redFileContent) {
  const zip = new JSZip();
  let fileCount = 0;

  Object.keys(outputs).forEach(k => {
    const o = outputs[k];
    if (o.type === "web-ara") {
      const txt = buildFileContent(o);
      if (!txt) return;
      const name = `${o.coName}_${o.araId}_ARA.ara`;
      zip.file(name, txt.replace(/\r?\n/g, "\r\n"));
      fileCount++;
    }
  });

  Object.keys(outputs).forEach(k => {
    const o = outputs[k];
    if (o.type === "web-key" || o.type === "web-tg") {
      const txt = buildFileContent(o);
      if (!txt) return;
      let name = "";
      if (o.type === "web-key") name = `${o.coName}_${o.tgId}_KEY.txt`;
      if (o.type === "web-tg")  name = `${o.coName}_${o.tgId}_TG.txt`;
      zip.file(name, txt.replace(/\r?\n/g, "\r\n"));
      fileCount++;
    }
  });

  Object.keys(outputs).forEach(k => {
    const o = outputs[k];
    if (o.type === "bin-ara") {
      const txt = buildFileContent(o);
      if (!txt) return;
      const name = `${o.coName}_${o.araId}_ARA.ara`;
      zip.file(name, txt.replace(/\r?\n/g, "\r\n"));
      fileCount++;
    }
  });

  const allTxt = buildAllInOne(outputs, redFileContent || "");
  zip.file("download_all.txt", allTxt.replace(/\r?\n/g, "\r\n"));
  fileCount++;

  if (fileCount === 0) {
    alert("沒有任何檔案可供下載");
    return;
  }

  const now = new Date();
  const dd = String(now.getDate()).padStart(2, "0");
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const yyyy = now.getFullYear();
  const fileName = `${dd}${mm}${yyyy}.rar`;

  const blob = await zip.generateAsync({ type: "blob" });
  saveAs(blob, fileName);
}

/* 按鈕事件 */
allocateBtn.onclick = () => {
  if (!validateWeekRequired()) return;
  if (!validateOtherFileRequired()) return;

  const o = allocateOnce();
  if (!o) return;

  saveLastConfig();

  lastOutputs = o;
  summaryArea.innerHTML = buildSummary(o);
  downloadAllRarBtn.disabled = false;
};

downloadAllRarBtn.onclick = () => {
  if (!lastOutputs) {
    alert("請先分配");
    return;
  }
  downloadAllRar(lastOutputs, redFileContent || "");
};

/* 預設 Web / Bin（無歷史設定才套用） */
function addWebPreset(coName, araId, tgId, tgFormat) {
  const tr = createWebRow();
  tr.querySelector(".web-co-name").value = coName;
  tr.querySelector(".web-ara-id").value = araId;
  tr.querySelector(".web-tg-id").value = tgId;
  tr.querySelector(".web-tg-format").value = tgFormat || "dateFirst";
  webTableBody.appendChild(tr);
}

function addBinPreset(coName, araId) {
  const tr = createBinRow();
  tr.querySelector(".bin-co-name").value = coName;
  tr.querySelector(".bin-ara-id").value = araId;
  binTableBody.appendChild(tr);
}

if (!restoreLastConfig()) {
  addWebPreset("M999KG", "3K88",   "3K880186", "dateFirst");
  addWebPreset("M999KB1", "3K01",  "3K010085", "dateFirst");
  addWebPreset("M999KB2", "3K01",  "3K010088", "dateFirst");
  addWebPreset("MM38",   "11G001", "11GPX88",  "tgFirst");
  addWebPreset("MM38",   "11G001", "11G139",   "tgFirst");

  addBinPreset("BC128",  "K39");
  addBinPreset("LIAN88", "39");
}

document.getElementById("add-web-row-btn").onclick = () =>
  webTableBody.appendChild(createWebRow());

document.getElementById("add-bin-row-btn").onclick = () =>
  binTableBody.appendChild(createBinRow());

const saveWebConfigBtn = document.getElementById("save-web-config-btn");
const saveBinConfigBtn = document.getElementById("save-bin-config-btn");

if (saveWebConfigBtn) {
  saveWebConfigBtn.addEventListener("click", () => {
    saveLastConfig();
    alert("Web / Bin 設定已儲存 (Saved Web/Bin settings)");
  });
}

if (saveBinConfigBtn) {
  saveBinConfigBtn.addEventListener("click", () => {
    saveLastConfig();
    alert("Web / Bin 設定已儲存 (Saved Web/Bin settings)");
  });
}
</script>

</div>
</body>
</html>
