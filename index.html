<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web/Bin è¨­å®šèˆ‡åˆ†é… v16</title>

  <style>
    :root{
      --bg: #f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --success:#16a34a;
      --warn:#f59e0b;
      --error:#ef4444;
      --note-bg:#f2f5ff;
      --note-line:#3b6ff9;
      --radius: 12px;
      --shadow: 0 6px 20px rgba(17,24,39,0.08);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI",
                   "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
    }

    /* WB å°ˆç”¨ï¼šå¯¬ç‰ˆä½†ä»ä¿ç•™ GEN é¢¨æ ¼ */
    .page{
      max-width: 1100px;
      margin: 20px auto 48px;
      padding: 0 18px;
    }

    /* Header */
    .header{
      background: linear-gradient(135deg, #ffffff 0%, #f7f9ff 100%);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title-wrap{
      display:flex; flex-direction:column; gap:4px;
    }
    h1{
      margin:0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      background:#eef2ff;
      color:#3730a3;
      border-radius:999px;
      border:1px solid #e0e7ff;
      white-space:nowrap;
    }

    /* Cards / Steps */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      margin-bottom:14px;
      position: relative;
    }
    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .step{
      display:flex; align-items:center; gap:10px;
    }
    .step-badge{
      width:30px; height:30px;
      border-radius:8px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:700;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #e0e7ff;
      flex: 0 0 auto;
    }
    .card-title{
      font-size:17px;
      font-weight:700;
    }

    /* Toggle note button */
    .toggle-btn{
      cursor:pointer;
      font-size:12px;
      color:var(--primary);
      user-select:none;
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:8px;
      border:1px dashed #dbe3ff;
      background:#f8faff;
      white-space:nowrap;
    }
    .toggle-btn:hover{ background:#eef2ff; }

    .note-box{
      background: var(--note-bg);
      border-left: 4px solid var(--note-line);
      padding: 12px 14px;
      border-radius: 8px;
      line-height: 1.6;
      color:#0f172a;
      font-size:13px;
      margin-top: 10px;
      white-space: pre-line;
    }
    .hidden{ display:none; }

    /* Form æ¨£å¼ï¼ˆæ¡Œæ©Ÿ3æ¬„ï¼‰ */
    .form-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px 12px;
    }
    @media (max-width: 900px){
      .form-row{ grid-template-columns: 1fr; }
    }
    .form-item{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:14px;
      font-weight:600;
      color:#111827;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    input[type="number"], input[type="text"]{
      width:100%;
      height:36px;
      padding: 6px 10px;
      border-radius: 8px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input[type="file"]{
      width:100%;
      padding:8px;
      border:1px dashed var(--line);
      border-radius: 8px;
      background:#fafafa;
      font-size:14px;
    }

    /* è¡¨æ ¼ */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 6px;
      vertical-align: middle;
    }
    th{
      background:#f9fafb;
      font-weight:600;
    }

    /* Buttons */
    .btn{
      border:0;
      cursor:pointer;
      font-size:15px;
      font-weight:700;
      padding: 10px 16px;
      border-radius: 10px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .05s ease, background .15s ease, opacity .15s;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
      box-shadow: 0 6px 14px rgba(37,99,235,0.25);
    }
    .btn-primary:hover{ background:var(--primary-2); }
    .btn-secondary{
      background:#0ea5a5;
      color:#fff;
      box-shadow: 0 6px 14px rgba(14,165,165,0.24);
    }
    .btn-danger{
      background:#ef4444;
      color:#fff;
    }
    .actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    #summary-area{
      margin-top:12px;
      font-size:13px;
      background:#f9fafb;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--line);
    }

    /* âœ… çµ±ä¸€å¯¬åº¦ç”¨ï¼ˆç¬¬6æ®µåŠ  class å¾Œå°±æœƒç”Ÿæ•ˆï¼‰ */
    .uniform-cell input,
    .uniform-cell select,
    .uniform-cell .kta-row input{
      width: 70px !important;
      max-width: 70px !important;
    }

.kta-row {
  display: flex;
  gap: 6px;
  white-space: nowrap;   /* ğŸ”¥ é€™ä¸€è¡Œ = æ°¸é ä¸æ›è¡Œ */
}

/* âœ… Binï¼šä¸‰æ¬„å¹³å‡ä¸‰ç­‰ä»½ï¼ˆåªå½±éŸ¿ Bin è¡¨æ ¼ï¼‰ */
#bin-table th.bin-uniform,
#bin-table td.bin-uniform{
  width:33%;
}

#bin-table td.bin-uniform input{
  width:100% !important;
  max-width:100% !important;
}

/* âœ… åˆªé™¤æ¬„ä½é æœ€å³ */
#web-table td:last-child,
#bin-table td:last-child{
  text-align:right;
  width:1%;
  white-space:nowrap;
}

/* Summary è¡¨æ ¼ï¼šè¡¨é ­ + å…§å®¹ å…¨éƒ¨é å·¦ */
#summary-area table th,
#summary-area table td {
  text-align: left !important;
}

  </style>
</head>

<body>
<div class="page">

  <div class="header">
    <div class="title-wrap">
      <h1>Web/Bin è¨­å®šèˆ‡åˆ†é…</h1>
      <div class="subtitle"></div>
    </div>
    <div class="chip">RNG Tools</div>
  </div>

  <!-- Step 1ï¼šWeb è¨­å®š -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">1</div>
        <div class="card-title">è¨­å®š Web</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-web', this)">â“˜ é¡¯ç¤ºèªªæ˜</div>
    </div>

    <div id="note-web" class="note-box hidden">
ãƒ»æ¯ä¸€åˆ— Web çš„ã€ŒKey + TG + ARA = 100ã€
ãƒ»å…¨éƒ¨ Web çš„ Red% ç¸½å’Œ = 100
ãƒ»å…¨éƒ¨ Web + Bin çš„ Other% ç¸½å’Œ = 100
ãƒ»TG æ ¼å¼å¯é¸ï¼šæ˜ŸæœŸ ID è™Ÿç¢¼ å¤§-å° / ID æ˜ŸæœŸ è™Ÿç¢¼ å¤§-å°
ãƒ»ç”¨ä¾†åˆ†é…ç´…å­—èˆ‡å…¶ä»–è™Ÿç¢¼
    </div>

    <table id="web-table">
      <thead>
        <tr>
          <th>Co. Name</th>
          <th>ARA ID</th>
          <th>TG ID</th>
          <th>TG æ ¼å¼</th>
          <th>TG Cnt</th>
          <th>Key / TG / ARA</th>
          <th>Red%</th>
          <th>Other%</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions" style="justify-content:flex-start;">
      <button class="btn-primary" id="add-web-row-btn">+ æ–°å¢ Web </button>
    </div>
  </section>

  <!-- Step 2ï¼šBin è¨­å®š -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">2</div>
        <div class="card-title">è¨­å®š Bin</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-bin', this)">â“˜ é¡¯ç¤ºèªªæ˜</div>
    </div>

    <div id="note-bin" class="note-box hidden">
ãƒ»å…¨éƒ¨ Web + Bin çš„ Other% ç¸½å’Œ = 100
ãƒ»Bin åªæœ‰ ARAï¼ˆæ²’æœ‰ Key / TGï¼‰
ãƒ»Other% ä»£è¡¨ã€Œå…¶ä»–è™Ÿç¢¼ã€åˆ†åˆ° Bin çš„æ¯”ä¾‹
    </div>

<table id="bin-table">
  <thead>
    <tr>
      <th class="bin-uniform">Co. Name</th>
      <th class="bin-uniform">ARA ID</th>
      <th class="bin-uniform">Other%</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="actions" style="justify-content:flex-start;">
  <button class="btn-primary" id="add-bin-row-btn">+ æ–°å¢ Bin </button>
</div>
</section>

  <!-- Step 3ï¼šä¸Šå‚³æª”æ¡ˆ -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">3</div>
        <div class="card-title">ä¸Šå‚³ç´…å­— / å…¶ä»–å­—ï¼ˆå«é‡æ–°è¨­å®šå¤§è¬å°è¬ï¼‰</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-upload', this)">â“˜ é¡¯ç¤ºèªªæ˜</div>
    </div>

    <div id="note-upload" class="note-box hidden">
ç´…å­— TXT æ ¼å¼ï¼š
0001 2 4
1234 2 4
ï¼ˆå¯åªæœ‰ 4 ä½æ•¸ï¼ŒBig/Small æœƒç”¨ã€Œé‡æ–°è¨­å®šã€è¦†è“‹ï¼‰

å…¶ä»–å­— TXT æ ¼å¼ï¼ˆå« rï¼‰ï¼š
5678 1 2
8888r 1 0
ï¼ˆr æœƒä¾è¦å‰‡åªé€² Web-Key æˆ– Web-TGï¼‰

âš ï¸ æ˜ŸæœŸå¿…å¡«ï¼ŒæŒ‰ã€Œåˆ†é…ã€èˆ‡ã€Œä¸‹è¼‰ã€å‰æœƒæª¢æŸ¥ã€‚
    </div>

    <div class="form-row" style="margin-top:6px;">
      <div class="form-item" style="grid-column:1/-1;">
        <label>ä¸Šå‚³ç´…å­— TXT</label>
        <input type="file" id="red-file" accept=".txt" />
        <div class="hint">ä¸Šå‚³ç´…å­—æª”æ¡ˆå¾Œï¼Œå¯é¸æ“‡æ˜¯å¦é‡æ–°è¦†è“‹ Big / Small</div>
      </div>
    </div>

<div class="form-row">
  <div class="form-item">
    <label>é‡æ–°è¨­å®šç´…å­—å¤§è¬ (Big)</label>
    <input type="number" id="red-big" placeholder="ä¸å¡«å‰‡ä¿ç•™åŸæœ¬" step="0.01" />
    <div class="hint">åªå¥—ç”¨ç´…å­—æª”ï¼ˆå¯ç•™ç©ºï¼‰</div>
  </div>
  <div class="form-item">
    <label>é‡æ–°è¨­å®šç´…å­—å°è¬ (Small)</label>
    <input type="number" id="red-small" placeholder="ä¸å¡«å‰‡ä¿ç•™åŸæœ¬" step="0.01" />
    <div class="hint">åªå¥—ç”¨ç´…å­—æª”ï¼ˆå¯ç•™ç©ºï¼‰</div>
  </div>
  <div class="form-item">
    <label>æ˜ŸæœŸï¼ˆå¿…å¡«ï¼‰</label>
    <input type="number" id="other-week" step="1" placeholder="ä¾‹å¦‚ï¼š3" />
    <div class="hint">æŒ‰ã€Œåˆ†é… / ä¸‹è¼‰ã€å‰ä¸€å®šè¦å¡«å¯«</div>
  </div>
</div>

    <div class="form-row" style="margin-top:6px;">
      <div class="form-item" style="grid-column:1/-1;">
        <label>ä¸Šå‚³å…¶ä»–å­— TXT</label>
        <input type="file" id="other-file" accept=".txt" />
        <div class="hint">åŒ…å«ä¸€èˆ¬è™Ÿç¢¼èˆ‡ r è™Ÿç¢¼</div>
      </div>
    </div>
  </section>

  <!-- Step 4ï¼šåˆ†é… & ä¸‹è¼‰ -->
  <section class="card">
    <div class="card-head">
      <div class="step">
        <div class="step-badge">4</div>
        <div class="card-title">åˆ†é…ä¸¦ä¸‹è¼‰ï¼ˆWeb/Bin åˆ†é–‹ä¸‹è¼‰ï¼‰</div>
      </div>
      <div class="toggle-btn" onclick="toggleNote('note-download', this)">â“˜ é¡¯ç¤ºèªªæ˜</div>
    </div>

    <div id="note-download" class="note-box hidden">
ä½¿ç”¨æµç¨‹ï¼š
1) å…ˆæŒ‰ã€Œâ¶ åˆ†é…ä¸¦é¡¯ç¤ºæ¯”ä¾‹ã€ç”¢ç”Ÿçµæœ
2) éœ€è¦é‡æ–°äº‚æ•¸ â†’ æŒ‰ã€Œé‡æ–°åˆ†é…ã€
3) âœ… ç¢ºèªæ¯”ä¾‹ OK å¾Œå†ä¸‹è¼‰
   ãƒ»â· ä¸‹è¼‰ Web_ARA â†’ åªä¸‹è¼‰ Web-ARA
   ãƒ»â¸ ä¸‹è¼‰ Web_KEY/TG â†’ åªä¸‹è¼‰ Web-Key + Web-TG
   ãƒ»â¹ ä¸‹è¼‰ Bin â†’ Bin-ARA å„è‡ªä¸€å€‹ txt
   ãƒ»âº ä¸‹è¼‰ Download_All â†’ æ•´åˆå…¨éƒ¨å€å¡Šï¼ˆæ–°ç‰ˆæ ¼å¼ï¼‰

âš ï¸ ä¸ä½¿ç”¨ ZIPï¼ˆé¿å… Windows æ“‹ä¸‹è¼‰ï¼‰
    </div>

    <div class="actions" style="justify-content:flex-start;">
      <button class="btn-primary" id="allocate-btn">â¶ åˆ†é…ä¸¦é¡¯ç¤ºæ¯”ä¾‹</button>
      <button class="btn-secondary" id="rerun-btn" disabled>é‡æ–°åˆ†é…</button>
    </div>

    <div class="actions" style="justify-content:flex-start; margin-top:6px;">
      <button class="btn" id="download-web-ara-btn" disabled>â· ä¸‹è¼‰ Web_ARA æª”æ¡ˆ</button>
      <button class="btn" id="download-web-keytg-btn" disabled>â¸ ä¸‹è¼‰ Web_KEY/TG æª”æ¡ˆ</button>
      <button class="btn" id="download-bin-btn" disabled>â¹ ä¸‹è¼‰ Bin æª”æ¡ˆ</button>
      <button class="btn" id="download-all-btn" disabled>âº ä¸‹è¼‰ Download_All æª”æ¡ˆ</button>
    </div>

    <div id="summary-area" class="hint"></div>
  </section>

<script>
/* =========================================================
   âœ… GENv10 UIï¼šèªªæ˜å±•é–‹/æ”¶åˆï¼ˆåªåŠ é€™å€‹ UI åŠŸèƒ½ï¼‰
========================================================= */
function toggleNote(id, btnEl) {
  const note = document.getElementById(id);
  if (!note) return;
  if (note.classList.contains('hidden')) {
    note.classList.remove('hidden');
    btnEl.textContent = 'â“˜ éš±è—èªªæ˜';
  } else {
    note.classList.add('hidden');
    btnEl.textContent = 'â“˜ é¡¯ç¤ºèªªæ˜';
  }
}

/* ---------------------------------------------------------
   å…¨åŸŸè®Šæ•¸ & DOM
--------------------------------------------------------- */
const webTableBody = document.querySelector('#web-table tbody');
const binTableBody = document.querySelector('#bin-table tbody');

const redFileInput = document.getElementById('red-file');
const otherFileInput = document.getElementById('other-file');
const redBigInput = document.getElementById('red-big');
const redSmallInput = document.getElementById('red-small');
const otherWeekInput = document.getElementById('other-week');

const allocateBtn = document.getElementById('allocate-btn');
const rerunBtn = document.getElementById('rerun-btn');
const downloadWebAraBtn = document.getElementById('download-web-ara-btn');
const downloadWebKeyTgBtn = document.getElementById('download-web-keytg-btn');
const downloadBinBtn = document.getElementById('download-bin-btn');
const downloadAllBtn = document.getElementById('download-all-btn');
const summaryArea = document.getElementById('summary-area');

let redFileContent = '';
let otherFileContent = '';
let lastOutputs = null;

/* ---------------------------------------------------------
   å¼·åˆ¶æª¢æŸ¥ï¼šæ˜ŸæœŸå¿…å¡«
--------------------------------------------------------- */
function validateWeekRequired() {
  const week = otherWeekInput.value.trim();
  if (week === "") {
    alert("è«‹å…ˆå¡«å¯«ã€æ˜ŸæœŸã€");
    return false;
  }
  return true;
}

/* ---------------------------------------------------------
   å·¥å…·å‡½å¼
--------------------------------------------------------- */
function rand() { return Math.random(); }

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function bigSmallDash(b, s) {
  b = b || 0;
  s = s || 0;
  if (b > 0 && s > 0) return `${b}-${s}`;
  if (b > 0 && s == 0) return `${b}-`;
  if (b == 0 && s > 0) return `-${s}`;
  return `-`;
}

function formatKeyLine(r) {
  return `${r.num} ${bigSmallDash(r.big, r.small)}`;
}

function padLeft(str, width) {
  str = String(str);
  if (str.length >= width) return str;
  return " ".repeat(width - str.length) + str;
}

function formatAraLine(r, araIdOverride) {
  const dateStr = r.date || "";
  let araId = araIdOverride || r.araId || "";
  const b = r.big || 0;
  const s = r.small || 0;

  const bigField   = b > 0 ? padLeft(b, 4) : "    ";
  const smallField = s > 0 ? padLeft(s, 3) : "   ";

  // ARA ID è‹¥å°‘æ–¼ 4 å€‹å­—å…ƒï¼Œè£œç©ºç™½åˆ°é•·åº¦ 4
  if (araId.length < 4) {
    araId = araId + " ".repeat(4 - araId.length);
  }

  return `${dateStr}+${r.num}+${bigField}+${smallField}+${araId}*1|N`;
}

/* ---------------------------------------------------------
   å»ºç«‹ Web / Bin åˆ—
   ï¼ˆåªæ”¹ UI classï¼šåˆªé™¤æŒ‰éˆ•åŠ ä¸Š btn / btn-dangerï¼‰
--------------------------------------------------------- */
function createWebRow() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="web-co-name"></td>
    <td><input type="text" class="web-ara-id"></td>
    <td><input type="text" class="web-tg-id"></td>

    <td>
      <select class="web-tg-format">
        <option value="dateFirst">æ˜ŸæœŸ ID</option>
        <option value="tgFirst">ID æ˜ŸæœŸ</option>
      </select>
    </td>

<td class="uniform-cell">
  <input type="text" class="web-tg-cnt" placeholder="0-10">
</td>

<td class="uniform-cell">
  <div class="kta-row">
    <input type="number" class="kta kta-key" placeholder="Key" step="0.01">
    <input type="number" class="kta kta-tg"  placeholder="TG"  step="0.01">
    <input type="number" class="kta kta-ara" placeholder="ARA" step="0.01">
  </div>
</td>

<td class="uniform-cell">
  <input type="number" class="web-red" step="0.01">
</td>

<td class="uniform-cell">
  <input type="number" class="web-other" step="0.01">
</td>

    <td><button class="btn btn-danger btn-delete-row">åˆª</button></td>
  `;
  tr.querySelector(".btn-delete-row").onclick = () => tr.remove();
  return tr;
}

function createBinRow() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="bin-uniform"><input type="text" class="bin-co-name"></td>
    <td class="bin-uniform"><input type="text" class="bin-ara-id"></td>
    <td class="bin-uniform"><input type="number" class="bin-other-percent" step="0.01"></td>
    <td class="delete-cell"><button class="btn btn-danger btn-delete-row">åˆª</button></td>
  `;
  tr.querySelector(".btn-delete-row").onclick = () => tr.remove();
  return tr;
}

/* ---------------------------------------------------------
   ä¸Šå‚³ç´…å­— / å…¶ä»–å­—
--------------------------------------------------------- */
redFileInput.addEventListener("change", e => {
  const f = e.target.files[0];
  redFileContent = "";
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    redFileContent = reader.result || "";
    console.log("ç´…å­—æª”æ¡ˆå·²è®€å–");
  };
  reader.readAsText(f, "utf-8");
});

otherFileInput.addEventListener("change", e => {
  const f = e.target.files[0];
  otherFileContent = "";
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    otherFileContent = reader.result || "";
    console.log("å…¶ä»–å­—æª”æ¡ˆå·²è®€å–");
  };
  reader.readAsText(f, "utf-8");
});

/* ---------------------------------------------------------
   è§£æç´…å­—ï¼ˆè™Ÿç¢¼ å¤§ å°ï¼Œå…è¨±è¦†è“‹å¤§è¬/å°è¬ï¼‰
--------------------------------------------------------- */
function parseRedNumbers(cfg) {
  const res = [];
  const txt = cfg.red.content || "";

  const overrideBig =
    cfg.red.big !== undefined && cfg.red.big !== "" ? Number(cfg.red.big) : null;
  const overrideSmall =
    cfg.red.small !== undefined && cfg.red.small !== "" ? Number(cfg.red.small) : null;

  txt.split(/\r?\n/).forEach(line => {
    const s = line.trim();
    if (!s) return;

    const parts = s.split(/\s+/);
    const numOnly = parts[0];

    if (!/^\d{4}$/.test(numOnly)) return;

    let originalBig = 0;
    let originalSmall = 0;

    if (parts.length >= 3) {
      const b = Number(parts[1]);
      const sm = Number(parts[2]);
      if (!Number.isNaN(b)) originalBig = b;
      if (!Number.isNaN(sm)) originalSmall = sm;
    }

    res.push({
      num: numOnly,
      baseNum: numOnly,
      displayNum: numOnly,
      big: overrideBig !== null ? overrideBig : originalBig,
      small: overrideSmall !== null ? overrideSmall : originalSmall,
      isRed: true,
      isRoll: false
    });
  });

  return res;
}

/* ---------------------------------------------------------
   è§£æå…¶ä»–å­—ï¼ˆå« r è™Ÿç¢¼ï¼‰
--------------------------------------------------------- */
function parseOtherNumbers(cfg) {
  const res = [];
  const txt = cfg.other.content || "";

  txt.split(/\r?\n/).forEach(line => {
    const s = line.trim();
    if (!s) return;

    const parts = s.split(/\s+/);
    if (parts.length < 3) return;

    let head = parts[0];
    let bigStr = parts[1];
    let smallStr = parts[2];

    let isRoll = false;
    let baseNum = "";

    if (/^\d{4}r$/i.test(head)) {
      isRoll = true;
      baseNum = head.slice(0, 4);
    } else if (/^\d{4}$/.test(head)) {
      baseNum = head;
    } else {
      return;
    }

    const big = Number(bigStr);
    const small = Number(smallStr);
    if (Number.isNaN(big) || Number.isNaN(small)) return;

    res.push({
      num: head,
      displayNum: head,
      baseNum,
      big,
      small,
      isRed: false,
      isRoll
    });
  });

  return res;
}

/* ---------------------------------------------------------
   å–å¾— Web/Bin è¨­å®š & é©—è­‰ç™¾åˆ†æ¯”
--------------------------------------------------------- */
function getCurrentConfig() {
  const web = [...webTableBody.querySelectorAll("tr")].map(tr => ({
    coName: tr.querySelector(".web-co-name").value.trim(),
    araId:  tr.querySelector(".web-ara-id").value.trim(),
    tgId:   tr.querySelector(".web-tg-id").value.trim(),
    tgFormat: tr.querySelector(".web-tg-format").value,
    tgCnt: tr.querySelector(".web-tg-cnt").value.trim(),
    keyVal:   tr.querySelector(".kta-key").value,
    tgVal:    tr.querySelector(".kta-tg").value,
    araVal:   tr.querySelector(".kta-ara").value,
    redPercent:   tr.querySelector(".web-red").value,
    otherPercent: tr.querySelector(".web-other").value
  }));

  const bin = [...binTableBody.querySelectorAll("tr")].map(tr => ({
    coName: tr.querySelector(".bin-co-name").value.trim(),
    araId:  tr.querySelector(".bin-ara-id").value.trim(),
    otherPercent: tr.querySelector(".bin-other-percent").value
  }));

  return {
    web,
    bin,
    red: {
      content: redFileContent,
      big: redBigInput.value,
      small: redSmallInput.value
    },
    other: {
      content: otherFileContent,
      week: otherWeekInput.value
    }
  };
}

/* ---------------------------------------------------------
   é©—è­‰ç™¾åˆ†æ¯”
--------------------------------------------------------- */
function validatePercents(cfg) {
  const epsilon = 0.001;
  let sumRed = 0;
  let sumOther = 0;

  // Web
  cfg.web.forEach((w, idx) => {
    const r = w.redPercent ? Number(w.redPercent) : 0;
    const o = w.otherPercent ? Number(w.otherPercent) : 0;
    sumRed += r;
    sumOther += o;

    const key = w.keyVal ? Number(w.keyVal) : 0;
    const tg  = w.tgVal  ? Number(w.tgVal)  : 0;
    const ara = w.araVal ? Number(w.araVal) : 0;
    const sumKTA = key + tg + ara;

    if (key || tg || ara) {
      if (Math.abs(sumKTA - 100) > epsilon) {
        alert(`ç¬¬ ${idx+1} åˆ— Web çš„ Key+TG+ARA å¿…é ˆ = 100`);
        throw "break";
      }
    }
  });

  // Bin
  cfg.bin.forEach(b => {
    const o = b.otherPercent ? Number(b.otherPercent) : 0;
    sumOther += o;
  });

  if (Math.abs(sumRed - 100) > epsilon) {
    alert(`å…¨éƒ¨ Web çš„ Red % å¿…é ˆ = 100ï¼Œç›®å‰ç‚º ${sumRed}`);
    return false;
  }
  if (Math.abs(sumOther - 100) > epsilon) {
    alert(`å…¨éƒ¨ Web+Bin çš„ Other % å¿…é ˆ = 100ï¼Œç›®å‰ç‚º ${sumOther}`);
    return false;
  }
  return true;
}

/* ---------------------------------------------------------
   åˆ†é…æ ¸å¿ƒ allocateOnce()
--------------------------------------------------------- */
function allocateOnce() {
  const cfg = getCurrentConfig();
  if (!validatePercents(cfg)) return null;

  const redList   = parseRedNumbers(cfg);
  const otherList = parseOtherNumbers(cfg);
  const pool = [...redList, ...otherList];

  const dateVal = cfg.other.week || "";

  const webList = cfg.web.map((w, idx) => ({
    index: idx,
    coName: w.coName || `Web${idx+1}`,
    araId:  w.araId || "",
    tgId:   w.tgId || "",
    tgFormat: w.tgFormat,
    keyPct:  w.keyVal   ? Number(w.keyVal)   : 0,
    tgPct:   w.tgVal    ? Number(w.tgVal)    : 0,
    araPct:  w.araVal   ? Number(w.araVal)   : 0,
    redPct:  w.redPercent   ? Number(w.redPercent)   : 0,
    otherPct:w.otherPercent ? Number(w.otherPercent) : 0
  }));

  const binList = cfg.bin.map((b, idx) => ({
    index: idx,
    coName: b.coName || `Bin${idx+1}`,
    araId:  b.araId || "",
    otherPct: b.otherPercent ? Number(b.otherPercent) : 0
  }));

  const webRedWeights   = webList.map(w => Math.max(0, w.redPct));
  const webOtherWeights = webList.map(w => Math.max(0, w.otherPct));
  const binOtherWeights = binList.map(b => Math.max(0, b.otherPct));

  const outputs = {};

  function ensureWebKey(co, tg) {
    const key = `web-key::${co}::${tg}`;
    if (!outputs[key]) outputs[key] = { type: "web-key", coName: co, tgId: tg, list: [] };
    return outputs[key];
  }
  function ensureWebTg(co, tg, fmt) {
    const key = `web-tg::${co}::${tg}`;
    if (!outputs[key]) outputs[key] = { type: "web-tg", coName: co, tgId: tg, tgFormat: fmt, list: [] };
    return outputs[key];
  }
  function ensureWebAra(co, ara) {
    const key = `web-ara::${co}::${ara}`;
    if (!outputs[key]) outputs[key] = { type: "web-ara", coName: co, araId: ara, list: [] };
    return outputs[key];
  }
  function ensureBinAra(co, ara) {
    const key = `bin-ara::${co}::${ara}`;
    if (!outputs[key]) outputs[key] = { type: "bin-ara", coName: co, araId: ara, list: [] };
    return outputs[key];
  }

  function pickIndex(weights) {
    const total = weights.reduce((s, x) => s + x, 0);
    if (total <= 0) return -1;
    let r = rand() * total;
    for (let i = 0; i < weights.length; i++) {
      r -= weights[i];
      if (r <= 0) return i;
    }
    return weights.length - 1;
  }

  /* ------------------- åˆ†é… ------------------- */
  for (const obj of pool) {
    const isRed  = obj.isRed;
    const isRoll = !!obj.isRoll;
    const num    = obj.displayNum;
    const big    = obj.big;
    const small  = obj.small;

    /* ----- ç´…å­— ----- */
    if (isRed) {
      const idx = pickIndex(webRedWeights);
      const w = webList[idx];
      const t = w.keyPct + w.tgPct + w.araPct;

      if (t <= 0) {
        ensureWebAra(w.coName, w.araId).list.push({ num, big, small, date: dateVal, isRoll });
        continue;
      }

      let r = rand() * t;
      if (r <= w.keyPct) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, big, small, isRoll });
      } else if (r <= w.keyPct + w.tgPct) {
        ensureWebTg(w.coName, w.tgId, w.tgFormat).list.push({ num, big, small, date: dateVal, isRoll });
      } else {
        ensureWebAra(w.coName, w.araId).list.push({ num, big, small, date: dateVal, isRoll });
      }
      continue;
    }

    /* ----- r è™Ÿç¢¼ ----- */
    if (isRoll) {
      const candidateIdx = [];
      const candidateWeights = [];

      webList.forEach((w, i) => {
        const canTakeR = (webOtherWeights[i] > 0) && ((w.keyPct + w.tgPct) > 0);
        if (canTakeR) {
          candidateIdx.push(i);
          candidateWeights.push(webOtherWeights[i]);
        }
      });

      if (!candidateIdx.length) {
        alert("æœ‰ r è™Ÿç¢¼ï¼Œä½†æ²’æœ‰ä»»ä½•å¯æ¥æ”¶ r çš„ Webï¼ˆéœ€ Other% > 0 ä¸” Key+TG > 0ï¼‰");
        return null;
      }

      const pickPos = pickIndex(candidateWeights);
      const wIndex = candidateIdx[pickPos];
      const w = webList[wIndex];

      const t = w.keyPct + w.tgPct;
      let rVal = rand() * t;

      if (rVal <= w.keyPct) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, big, small, isRoll });
      } else {
        ensureWebTg(w.coName, w.tgId, w.tgFormat).list.push({ num, big, small, date: dateVal, isRoll });
      }
      continue;
    }

    /* ----- å…¶ä»–å­— ----- */
    const totalOther =
      webOtherWeights.reduce((s, x) => s + x, 0) +
      binOtherWeights.reduce((s, x) => s + x, 0);

    if (totalOther <= 0) continue;

    let r = rand() * totalOther;
    let acc = 0;
    let target = null;

    for (let i = 0; i < webList.length; i++) {
      acc += webOtherWeights[i];
      if (r <= acc) { target = { kind: "web", i }; break; }
    }
    if (!target) {
      for (let i = 0; i < binList.length; i++) {
        acc += binOtherWeights[i];
        if (r <= acc) { target = { kind: "bin", i }; break; }
      }
    }
    if (!target) continue;

    if (target.kind === "bin") {
      const bObj = binList[target.i];
      ensureBinAra(bObj.coName, bObj.araId)
        .list.push({ num, big, small, date: dateVal, isRoll });
    } else {
      const w = webList[target.i];
      const t2 = w.keyPct + w.tgPct + w.araPct;
      if (t2 <= 0) {
        ensureWebAra(w.coName, w.araId).list.push({ num, big, small, date: dateVal, isRoll });
        continue;
      }

      let r2 = rand() * t2;
      let acc2 = w.keyPct;
      if (r2 <= acc2) {
        ensureWebKey(w.coName, w.tgId).list.push({ num, big, small, isRoll });
        continue;
      }
      acc2 += w.tgPct;
      if (r2 <= acc2) {
        ensureWebTg(w.coName, w.tgId, w.tgFormat).list.push({ num, big, small, date: dateVal, isRoll });
        continue;
      }
      ensureWebAra(w.coName, w.araId).list.push({ num, big, small, date: dateVal, isRoll });
    }
  }

  return outputs;
}

/* ---------------------------------------------------------
   SUMMARY é¡¯ç¤º
--------------------------------------------------------- */
function buildSummary(outputs) {
  const rows = [];

  Object.keys(outputs).sort().forEach(k => {
    const o = outputs[k];
    const arr = o.list;
    const total = arr.length;
    const rollCount = arr.filter(x => x.isRoll).length;
    const pct = total === 0 ? 0 : (rollCount * 100 / total);

    let fileName = "";
    let typeName = "";

    if (o.type === "web-key") {
      fileName = `${o.coName}_${o.tgId}_KEY`;
      typeName = "KEY";
    }
    if (o.type === "web-tg") {
      fileName = `${o.coName}_${o.tgId}_TG`;
      typeName = "TG";
    }
    if (o.type === "web-ara") {
      fileName = `${o.coName}_${o.araId}_ARA(Web)`;
      typeName = "ARA(Web)";
    }
    if (o.type === "bin-ara") {
      fileName = `${o.coName}_${o.araId}_ARA(Bin)`;
      typeName = "ARA(Bin)";
    }

    rows.push(`
      <tr>
        <td>${fileName}</td>
        <td>${typeName}</td>
        <td>${total}</td>
        <td>${rollCount}</td>
        <td>${total - rollCount}</td>
        <td>${pct.toFixed(2)}%</td>
      </tr>
    `);
  });

  return `
    <table>
      <thead>
        <tr>
          <th>æª”æ¡ˆåç¨±</th>
          <th>é¡å‹</th>
          <th>ç¸½ç­†æ•¸</th>
          <th>r æ•¸é‡</th>
          <th>é r</th>
          <th>r%</th>
        </tr>
      </thead>
      <tbody>${rows.join("")}</tbody>
    </table>
  `;
}

/* ---------------------------------------------------------
   ä¸‹è¼‰å–®ä¸€ TXT
--------------------------------------------------------- */
function downloadTextFile(filename, content) {
  if (content == null) content = "";
  const crlfContent = content.replace(/\r?\n/g, "\r\n");
  const blob = new Blob([crlfContent], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* ---------------------------------------------------------
   ä¾ outputs å»ºç«‹å…§å®¹
--------------------------------------------------------- */
function buildFileContent(o) {
  const list = o.list;
  if (!list.length) return "";

  let content = "";

  if (o.type === "web-key") {
    shuffle(list);
    content = list.map(r => formatKeyLine(r)).join("\n");
  }

  if (o.type === "web-tg") {
    shuffle(list);
    content = list.map(r => {
      const date = r.date || "";
      const bs = bigSmallDash(r.big, r.small);
      if (o.tgFormat === "tgFirst") {
        return `${o.tgId} ${date} ${r.num} ${bs}`.trim();
      }
      return `${date} ${o.tgId} ${r.num} ${bs}`.trim();
    }).join("\n");
  }

  if (o.type === "web-ara" || o.type === "bin-ara") {
    shuffle(list);
    content = list.map(r => formatAraLine(r, o.araId)).join("\n");
  }

  return content;
}

/* ---------------------------------------------------------
   ä¸‹è¼‰ Download_Allï¼ˆæ•´åˆå…¨éƒ¨æª”æ¡ˆï¼‰
--------------------------------------------------------- */
function buildAllInOne(outputs, redFileContent) {

  function normLines(text) {
    return text.replace(/\r/g, "").split("\n").filter(l => l.trim() !== "");
  }

  const sections = [];
  const keys = Object.keys(outputs || {});

  function pushSection(type, name, lines) {
    const lineCount = lines.length;
    let block =
      `type:${type} ${name}\n` +
      `line:${lineCount}\n` +
      lines.join("\n") + "\n" +
      `endtype:${type} ${name}`;
    sections.push(block);
  }

  // 1) ARA (Web + Bin)
  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-ara" || o.type === "bin-ara")
    .sort((a,b)=> `${a.coName}_${a.araId}`.localeCompare(`${b.coName}_${b.araId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.araId}_ARA`;
      pushSection("ara", name, lines);
    });

  // 2) TG
  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-tg")
    .sort((a,b)=> `${a.coName}_${a.tgId}`.localeCompare(`${b.coName}_${b.tgId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.tgId}_TG`;
      pushSection("tg", name, lines);
    });

  // 3) KEYIN
  keys
    .map(k => outputs[k])
    .filter(o => o.type === "web-key")
    .sort((a,b)=> `${a.coName}_${a.tgId}`.localeCompare(`${b.coName}_${b.tgId}`, 'zh-Hant') )
    .forEach(o => {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;
      const lines = normLines(fileContent);
      const name = `${o.coName}_${o.tgId}_KEY`;
      pushSection("keyin", name, lines);
    });

  // 4) redfont (å›ºå®šåç¨±)
  if (redFileContent && redFileContent.trim()) {
    let lines = redFileContent.replace(/\r/g, "").split("\n");
    while (lines.length && lines[lines.length - 1].trim() === "") {
      lines.pop();
    }
    pushSection("redfont", "", lines);
  }

  return sections.join("\n");
}

/* ---------------------------------------------------------
   ä¸‹è¼‰ Web_ARAï¼ˆé€æª”ä¸‹è¼‰ï¼‰
--------------------------------------------------------- */
function downloadWebAra(outputs) {
  const keys = Object.keys(outputs);
  let count = 0;

  keys.forEach(k => {
    const o = outputs[k];
    if (o.type === "web-ara") {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;

      const fileName = `${o.coName}_${o.araId}_ARA.ara`;
      downloadTextFile(fileName, fileContent);
      count++;
    }
  });

  alert(`å·²ä¸‹è¼‰ Web_ARA æª”æ¡ˆ ${count} å€‹`);
}

/* ---------------------------------------------------------
   ä¸‹è¼‰ Web_KEY/TGï¼ˆé€æª”ä¸‹è¼‰ï¼‰
--------------------------------------------------------- */
function downloadWebKeyTg(outputs) {
  const keys = Object.keys(outputs);
  let count = 0;

  keys.forEach(k => {
    const o = outputs[k];
    if (o.type === "web-key" || o.type === "web-tg") {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;

      let fileName = "";
      if (o.type === "web-key") fileName = `${o.coName}_${o.tgId}_KEY.txt`;
      if (o.type === "web-tg")  fileName = `${o.coName}_${o.tgId}_TG.txt`;

      downloadTextFile(fileName, fileContent);
      count++;
    }
  });

  alert(`å·²ä¸‹è¼‰ Web_KEY/TG æª”æ¡ˆ ${count} å€‹`);
}

/* ---------------------------------------------------------
   ä¸‹è¼‰ Binï¼ˆé€æª”ä¸‹è¼‰ï¼‰
--------------------------------------------------------- */
function downloadBin(outputs) {
  const keys = Object.keys(outputs);
  let count = 0;

  keys.forEach(k => {
    const o = outputs[k];
    if (o.type === "bin-ara") {
      const fileContent = buildFileContent(o);
      if (!fileContent) return;

      const fileName = `${o.coName}_${o.araId}_ARA.ara`;
      downloadTextFile(fileName, fileContent);
      count++;
    }
  });

  alert(`å·²ä¸‹è¼‰ Bin æª”æ¡ˆ ${count} å€‹`);
}

/* ---------------------------------------------------------
   æŒ‰éˆ•äº‹ä»¶
--------------------------------------------------------- */
allocateBtn.onclick = () => {
  if (!validateWeekRequired()) return;
  const o = allocateOnce();
  if (!o) return;

  lastOutputs = o;
  summaryArea.innerHTML = buildSummary(o);

  rerunBtn.disabled = false;
  downloadWebAraBtn.disabled = false;
  downloadWebKeyTgBtn.disabled = false;
  downloadBinBtn.disabled = false;
  downloadAllBtn.disabled = false;
};

rerunBtn.onclick = () => {
  if (!validateWeekRequired()) return;
  const o = allocateOnce();
  if (!o) return;

  lastOutputs = o;
  summaryArea.innerHTML = buildSummary(o);

  downloadWebAraBtn.disabled = false;
  downloadWebKeyTgBtn.disabled = false;
  downloadBinBtn.disabled = false;
  downloadAllBtn.disabled = false;
};

downloadWebAraBtn.onclick = () => {
  if (!lastOutputs) {
    alert("è«‹å…ˆåˆ†é…");
    return;
  }
  downloadWebAra(lastOutputs);
};

downloadWebKeyTgBtn.onclick = () => {
  if (!lastOutputs) {
    alert("è«‹å…ˆåˆ†é…");
    return;
  }
  downloadWebKeyTg(lastOutputs);
};

downloadBinBtn.onclick = () => {
  if (!lastOutputs) {
    alert("è«‹å…ˆåˆ†é…");
    return;
  }
  downloadBin(lastOutputs);
};

downloadAllBtn.onclick = () => {
  if (!lastOutputs) {
    alert("è«‹å…ˆåˆ†é…");
    return;
  }
  const content = buildAllInOne(lastOutputs, redFileContent || "");
  if (!content) {
    alert("æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹");
    return;
  }
  downloadTextFile("download_all.txt", content);
};

/* ---------------------------------------------------------
   é è¨­ Web / Bin
--------------------------------------------------------- */
function addWebPreset(coName, araId, tgId, tgFormat) {
  const tr = createWebRow();
  tr.querySelector(".web-co-name").value = coName;
  tr.querySelector(".web-ara-id").value = araId;
  tr.querySelector(".web-tg-id").value = tgId;
  tr.querySelector(".web-tg-format").value = tgFormat || "dateFirst";
  webTableBody.appendChild(tr);
}

function addBinPreset(coName, araId) {
  const tr = createBinRow();
  tr.querySelector(".bin-co-name").value = coName;
  tr.querySelector(".bin-ara-id").value = araId;
  binTableBody.appendChild(tr);
}

/* Web é è¨­ */
addWebPreset("M999KG", "3K88",   "3K880186", "dateFirst");
addWebPreset("M999KB", "3KA01",  "3K010085", "dateFirst");
addWebPreset("M999KB", "3KA02",  "3K010088", "dateFirst");
addWebPreset("MM38",   "11G001", "11GPX88",  "tgFirst");
addWebPreset("MM38",   "11G001", "11G139",   "tgFirst");

/* Bin é è¨­ */
addBinPreset("BC128",  "K39A");
addBinPreset("LIAN88", "39A");

/* ---------------------------------------------------------
   æ–°å¢æŒ‰éˆ•
--------------------------------------------------------- */
document.getElementById("add-web-row-btn").onclick = () =>
  webTableBody.appendChild(createWebRow());

document.getElementById("add-bin-row-btn").onclick = () =>
  binTableBody.appendChild(createBinRow());

</script>

</div> <!-- page -->
</body>
</html>
